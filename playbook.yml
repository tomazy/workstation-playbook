---
- hosts: all

  pre_tasks:
    - name: Upgrade packages
      apt: upgrade=yes update_cache=yes cache_valid_time=3600
      sudo: yes

    - command: locale-gen en_US en_US.UTF-8
      sudo: yes

    - command: dpkg-reconfigure locales
      sudo: yes

    - lineinfile: >
        dest=/etc/default/locale
        state=present
        line='LC_ALL="en_US.UTF-8"'
      sudo: yes

    - name: Setup time zone
      sudo: yes
      file: >
        dest=/etc/localtime
        src=/usr/share/zoneinfo/Asia/Singapore
        state=link
        force=yes

    - name: Setup host name (workstation)
      sudo: yes
      shell: >
        echo workstation > /etc/hostname

  roles:
    - { role: tomazy.postgresql, postgresql_ext_install_dev_headers: yes }
    - { role: ruby }
    - { role: nodejs }
    - { role: java }
    - { role: workstation }
    - { role: gui }
    - { role: virtualbox }
    - { role: chrome }
    - { role: android }

  tasks:
    - shell: bash -lc 'gem list'
      register: gem_list
      tags: ['gems']

    - name: Install default ruby gems
      command: bash -lc 'gem install {{item}}'
      when: "'{{item}}' not in '{{gem_list.stdout}}'"
      with_items:
        - pry
        - rails
        - rails-api
        - guard
        - tmuxinator
        - sass
        - git-pair
        - librarian-ansible
      tags: ['gems']

    - name: Find current npm
      shell: sudo -iu $USER which npm
      register: npm_search

    - name: Install default node packages
      npm: >
        global=yes
        name={{item}}
        executable={{npm_search.stdout}}
      with_items:
        - bower
        - grunt-cli
        - cordova
